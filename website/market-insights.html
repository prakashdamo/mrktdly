<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Intelligence - Daily Market Summary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.6/dist/amazon-cognito-identity.min.js"></script>
    <script src="/js/auth-helper.js?v=20251203-3"></script>
    <script src="/js/nav.js?v=20251205-1"></script>
</head>
<body class="bg-slate-900 text-white antialiased">
    <div id="appNav" data-active="market-insights"></div>

    <div class="container mx-auto px-6 py-12 max-w-7xl">
        <!-- Header -->
        <div class="mb-12">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-5xl font-bold mb-3 bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">Market Intelligence</h1>
                    <p class="text-gray-400 text-lg">Real-time market analysis and trends</p>
                </div>
                <div id="lastUpdated" class="hidden text-right">
                    <div class="text-sm text-gray-500">Last updated</div>
                    <div class="text-sm font-medium text-gray-300" id="updateTime">-</div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p class="text-gray-400">Loading market data...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden bg-red-900/20 border border-red-500/50 rounded-xl p-6 mb-8">
            <p class="text-red-400" id="errorMessage"></p>
        </div>

        <!-- Stats Grid -->
        <div id="stats" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
            <div class="group bg-gradient-to-br from-slate-800/80 to-slate-800/40 backdrop-blur-sm rounded-2xl p-6 text-center shadow-lg hover:shadow-blue-500/20 hover:scale-105 transition-all duration-300 cursor-pointer border border-slate-700/50 hover:border-blue-500/50">
                <div class="text-4xl font-bold text-blue-400 mb-2 group-hover:scale-110 transition-transform" id="pctAboveMA200">-</div>
                <div class="text-gray-400 text-sm font-medium">Above 200-Day MA</div>
            </div>
            <div class="group bg-gradient-to-br from-slate-800/80 to-slate-800/40 backdrop-blur-sm rounded-2xl p-6 text-center shadow-lg hover:shadow-green-500/20 hover:scale-105 transition-all duration-300 cursor-pointer border border-slate-700/50 hover:border-green-500/50">
                <div class="text-4xl font-bold text-green-400 mb-2 group-hover:scale-110 transition-transform" id="bullishCount">-</div>
                <div class="text-gray-400 text-sm font-medium">Bullish Stocks</div>
            </div>
            <div class="group bg-gradient-to-br from-slate-800/80 to-slate-800/40 backdrop-blur-sm rounded-2xl p-6 text-center shadow-lg hover:shadow-red-500/20 hover:scale-105 transition-all duration-300 cursor-pointer border border-slate-700/50 hover:border-red-500/50">
                <div class="text-4xl font-bold text-red-400 mb-2 group-hover:scale-110 transition-transform" id="bearishCount">-</div>
                <div class="text-gray-400 text-sm font-medium">Bearish Stocks</div>
            </div>
            <div class="group bg-gradient-to-br from-slate-800/80 to-slate-800/40 backdrop-blur-sm rounded-2xl p-6 text-center shadow-lg hover:shadow-purple-500/20 hover:scale-105 transition-all duration-300 cursor-pointer border border-slate-700/50 hover:border-purple-500/50">
                <div class="text-4xl font-bold text-purple-400 mb-2 group-hover:scale-110 transition-transform" id="avgVolatility">-</div>
                <div class="text-gray-400 text-sm font-medium">Avg Volatility</div>
            </div>
        </div>

        <!-- Charts -->
        <div id="charts" class="hidden space-y-10">
            <!-- Today's Movers -->
            <div class="group bg-gradient-to-br from-slate-800/60 to-slate-800/30 backdrop-blur-sm rounded-2xl p-8 shadow-xl hover:shadow-2xl transition-all duration-300 border border-slate-700/30">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-2 h-8 bg-gradient-to-b from-yellow-400 to-orange-600 rounded-full"></div>
                    <div>
                        <h2 class="text-2xl font-bold">Today's Top Movers</h2>
                        <p class="text-gray-400 text-sm">Biggest moves in latest session</p>
                    </div>
                </div>
                <div id="todayMovers" style="height: 400px;"></div>
            </div>

            <!-- Two Column Grid - Recent Movers -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="group bg-gradient-to-br from-slate-800/60 to-slate-800/30 backdrop-blur-sm rounded-2xl p-8 shadow-xl hover:shadow-2xl transition-all duration-300 border border-slate-700/30">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-2 h-8 bg-gradient-to-b from-green-400 to-emerald-600 rounded-full"></div>
                        <div>
                            <h2 class="text-2xl font-bold">Last Week Top Movers</h2>
                            <p class="text-gray-400 text-sm">Hottest recent moves</p>
                        </div>
                    </div>
                    <div id="tenDayMovers" style="height: 400px;"></div>
                </div>

                <div class="group bg-gradient-to-br from-slate-800/60 to-slate-800/30 backdrop-blur-sm rounded-2xl p-8 shadow-xl hover:shadow-2xl transition-all duration-300 border border-slate-700/30">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-2 h-8 bg-gradient-to-b from-blue-400 to-indigo-600 rounded-full"></div>
                        <div>
                            <h2 class="text-2xl font-bold">1-Month Top Movers</h2>
                            <p class="text-gray-400 text-sm">Volume-confirmed plays</p>
                        </div>
                    </div>
                    <div id="oneMonthMovers" style="height: 400px;"></div>
                </div>
            </div>

            <!-- Two Column Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-gradient-to-br from-slate-800/60 to-slate-800/30 backdrop-blur-sm rounded-2xl p-8 shadow-xl hover:shadow-2xl transition-all duration-300 border border-slate-700/30">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-2 h-8 bg-gradient-to-b from-orange-400 to-red-600 rounded-full"></div>
                        <div>
                            <h2 class="text-2xl font-bold">Volatility Trends</h2>
                            <p class="text-gray-400 text-sm">Market risk over time</p>
                        </div>
                    </div>
                    <div id="volatilityTrend" style="height: 400px;"></div>
                </div>

                <div class="bg-gradient-to-br from-slate-800/60 to-slate-800/30 backdrop-blur-sm rounded-2xl p-8 shadow-xl hover:shadow-2xl transition-all duration-300 border border-slate-700/30">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-2 h-8 bg-gradient-to-b from-purple-400 to-pink-600 rounded-full"></div>
                        <div>
                            <h2 class="text-2xl font-bold">Sector Performance</h2>
                            <p class="text-gray-400 text-sm">Returns by sector</p>
                        </div>
                    </div>
                    <div id="sectorHeatmap" style="height: 400px;"></div>
                </div>
            </div>

            <!-- Momentum Quadrants - Full Width Featured -->
            <div class="bg-gradient-to-br from-slate-800/70 to-slate-800/40 backdrop-blur-sm rounded-2xl p-10 shadow-2xl border border-slate-700/40 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-64 h-64 bg-blue-500/5 rounded-full blur-3xl"></div>
                <div class="relative">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-3 h-10 bg-gradient-to-b from-cyan-400 to-blue-600 rounded-full"></div>
                        <div>
                            <h2 class="text-3xl font-bold">Momentum Quadrants</h2>
                            <p class="text-gray-400">Stocks categorized by momentum direction and strength</p>
                        </div>
                    </div>
                    <div id="momentumHeatmap"></div>
                </div>
            </div>

            <!-- Volume Patterns -->
            <div class="bg-gradient-to-br from-slate-800/60 to-slate-800/30 backdrop-blur-sm rounded-2xl p-8 shadow-xl hover:shadow-2xl transition-all duration-300 border border-slate-700/30">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-2 h-8 bg-gradient-to-b from-teal-400 to-cyan-600 rounded-full"></div>
                    <div>
                        <h2 class="text-2xl font-bold">Volume Patterns</h2>
                        <p class="text-gray-400 text-sm">Trading volume across major indices</p>
                    </div>
                </div>
                <div id="volumePatterns" style="height: 400px;"></div>
            </div>

            <!-- RSI Distribution -->
            <div class="bg-gradient-to-br from-slate-800/60 to-slate-800/30 backdrop-blur-sm rounded-2xl p-8 shadow-xl hover:shadow-2xl transition-all duration-300 border border-slate-700/30">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-2 h-8 bg-gradient-to-b from-yellow-400 to-orange-600 rounded-full"></div>
                    <div>
                        <h2 class="text-2xl font-bold">RSI Distribution</h2>
                        <p class="text-gray-400 text-sm">Market momentum snapshot • <span class="text-red-400">&lt;30 Oversold</span> • <span class="text-yellow-400">30-70 Neutral</span> • <span class="text-green-400">&gt;70 Overbought</span></p>
                    </div>
                </div>
                <div id="rsiDistribution" style="height: 400px;"></div>
            </div>

            <!-- Top Performers YTD -->
            <div class="bg-gradient-to-br from-slate-800/60 to-slate-800/30 backdrop-blur-sm rounded-2xl p-8 shadow-xl hover:shadow-2xl transition-all duration-300 border border-slate-700/30">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-2 h-8 bg-gradient-to-b from-emerald-400 to-green-600 rounded-full"></div>
                    <div>
                        <h2 class="text-2xl font-bold">Top Performers YTD</h2>
                        <p class="text-gray-400 text-sm">Best performing stocks by total return</p>
                    </div>
                </div>
                <div id="topPerformers" style="height: 400px;"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://xfi2u4ajm9.execute-api.us-east-1.amazonaws.com/prod';

        async function fetchMarketData() {
            const response = await authenticatedFetch(`${API_BASE}/market-insights`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
        }

        function createTodayMoversChart(data) {
            const trace = {
                x: data.returns.slice().reverse(),
                y: data.tickers.slice().reverse(),
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: data.returns.slice().reverse().map(r => r > 0 ? '#fbbf24' : '#f97316')
                },
                text: data.returns.slice().reverse().map(r => `${r.toFixed(1)}%`),
                textposition: 'outside'
            };

            const layout = {
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#e2e8f0' },
                xaxis: { title: 'Today\'s Return (%)', gridcolor: '#334155' },
                yaxis: { gridcolor: '#334155' },
                margin: { l: 60, r: 80, t: 20, b: 60 },
                height: 400
            };

            Plotly.newPlot('todayMovers', [trace], layout, {responsive: true});
        }

        function createTenDayMoversChart(data) {
            const trace = {
                x: data.returns.slice().reverse(),
                y: data.tickers.slice().reverse(),
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: data.returns.slice().reverse().map(r => r > 0 ? '#22c55e' : '#ef4444')
                },
                text: data.returns.slice().reverse().map(r => `${r.toFixed(1)}%`),
                textposition: 'outside'
            };

            const layout = {
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#e2e8f0' },
                xaxis: { title: 'Return (%)', gridcolor: '#334155' },
                yaxis: { gridcolor: '#334155' },
                margin: { l: 60, r: 80, t: 20, b: 60 },
                height: 400
            };

            Plotly.newPlot('tenDayMovers', [trace], layout, {responsive: true});
        }

        function createOneMonthMoversChart(data) {
            const trace = {
                x: data.returns.slice().reverse(),
                y: data.tickers.slice().reverse(),
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: data.returns.slice().reverse().map(r => r > 0 ? '#22c55e' : '#ef4444')
                },
                text: data.returns.slice().reverse().map((r, i) => 
                    `${r.toFixed(1)}% • ${data.volumes.slice().reverse()[i].toFixed(1)}x vol`
                ),
                textposition: 'outside',
                hovertemplate: '%{y}<br>Return: %{x:.1f}%<br>Volume: ' + 
                    data.volumes.slice().reverse().map(v => `${v.toFixed(1)}x`) + '<extra></extra>'
            };

            const layout = {
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#e2e8f0' },
                xaxis: { title: 'Return (%)', gridcolor: '#334155' },
                yaxis: { gridcolor: '#334155' },
                margin: { l: 60, r: 120, t: 20, b: 60 },
                height: 400
            };

            Plotly.newPlot('oneMonthMovers', [trace], layout, {responsive: true});
        }

        function createTopPerformersChart(data) {
            const trace = {
                x: data.returns.slice().reverse(),
                y: data.tickers.slice().reverse(),
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: data.returns.slice().reverse(),
                    colorscale: [[0, '#86efac'], [1, '#166534']],
                    showscale: true
                },
                text: data.returns.slice().reverse().map(r => `${r.toFixed(1)}%`),
                textposition: 'outside'
            };

            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#e2e8f0' },
                margin: { l: 80, r: 40, t: 20, b: 40 },
                xaxis: { title: 'YTD Return (%)', gridcolor: '#334155' },
                yaxis: { automargin: true, gridcolor: '#334155' },
                height: 400
            };

            Plotly.newPlot('topPerformers', [trace], layout, {responsive: true});
        }

        function createVolatilityTrendChart(data) {
            const trace = {
                x: data.dates,
                y: data.volatility,
                type: 'scatter',
                mode: 'lines',
                fill: 'tozeroy',
                line: { color: '#667eea', width: 2 },
                fillcolor: 'rgba(102, 126, 234, 0.2)'
            };

            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#e2e8f0' },
                margin: { l: 50, r: 40, t: 20, b: 40 },
                xaxis: { title: 'Date', gridcolor: '#334155' },
                yaxis: { title: 'Volatility (%)', gridcolor: '#334155' },
                height: 400
            };

            Plotly.newPlot('volatilityTrend', [trace], layout, {responsive: true});
        }

        function createSectorHeatmap(data) {
            const trace = {
                z: [data.returns],
                x: data.sectors,
                y: ['YTD Return'],
                type: 'heatmap',
                colorscale: [[0, '#dc2626'], [0.5, '#fbbf24'], [1, '#16a34a']],
                showscale: true,
                text: [data.returns.map(r => `${r.toFixed(1)}%`)],
                texttemplate: '%{text}',
                textfont: { size: 16, color: 'white', family: 'Arial, sans-serif' }
            };

            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#e2e8f0', size: 14 },
                margin: { l: 50, r: 40, t: 20, b: 120 },
                xaxis: { tickangle: -45, side: 'bottom', tickfont: { size: 14 } },
                yaxis: { visible: false },
                height: 250
            };

            Plotly.newPlot('sectorHeatmap', [trace], layout, {responsive: true});
        }

        function createVolumeChart(data) {
            const traces = data.tickers.map((ticker, i) => ({
                x: data.dates,
                y: data.volumes[i],
                name: ticker,
                type: 'scatter',
                mode: 'lines'
            }));

            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#e2e8f0' },
                margin: { l: 50, r: 40, t: 20, b: 40 },
                xaxis: { title: 'Date', gridcolor: '#334155' },
                yaxis: { title: 'Relative Volume', gridcolor: '#334155' },
                height: 400
            };

            Plotly.newPlot('volumePatterns', traces, layout, {responsive: true});
        }

        function createRSIChart(data) {
            const trace = {
                x: data.rsi,
                type: 'histogram',
                marker: { color: '#8b5cf6' },
                nbinsx: 30
            };

            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#e2e8f0' },
                margin: { l: 50, r: 40, t: 20, b: 40 },
                xaxis: { 
                    title: 'RSI Value', 
                    gridcolor: '#334155',
                    range: [0, 100]
                },
                yaxis: { title: 'Number of Stocks', gridcolor: '#334155' },
                shapes: [
                    // Oversold zone (red)
                    { type: 'rect', x0: 0, x1: 30, y0: 0, y1: 1, yref: 'paper', 
                      fillcolor: 'rgba(239, 68, 68, 0.1)', line: { width: 0 } },
                    // Overbought zone (green)
                    { type: 'rect', x0: 70, x1: 100, y0: 0, y1: 1, yref: 'paper', 
                      fillcolor: 'rgba(34, 197, 94, 0.1)', line: { width: 0 } },
                    // Oversold line
                    { type: 'line', x0: 30, x1: 30, y0: 0, y1: 1, yref: 'paper', 
                      line: { color: '#ef4444', dash: 'dash', width: 2 } },
                    // Overbought line
                    { type: 'line', x0: 70, x1: 70, y0: 0, y1: 1, yref: 'paper', 
                      line: { color: '#22c55e', dash: 'dash', width: 2 } }
                ],
                annotations: [
                    { x: 15, y: 0.95, yref: 'paper', text: 'Oversold', 
                      showarrow: false, font: { color: '#ef4444', size: 12 } },
                    { x: 85, y: 0.95, yref: 'paper', text: 'Overbought', 
                      showarrow: false, font: { color: '#22c55e', size: 12 } }
                ],
                height: 400
            };

            Plotly.newPlot('rsiDistribution', [trace], layout, {responsive: true});
        }

        function createMomentumHeatmap(data) {
            const quadrants = {
                strong_accel: [], strong_decel: [],
                weak_recover: [], weak_falling: []
            };
            
            data.forEach(item => {
                const ret5d = item.momentum[0];
                const ret20d = item.momentum[1];
                const accel = ret5d > ret20d;
                
                if (ret20d > 0 && accel) quadrants.strong_accel.push(item);
                else if (ret20d > 0 && !accel) quadrants.strong_decel.push(item);
                else if (ret20d < 0 && accel) quadrants.weak_recover.push(item);
                else quadrants.weak_falling.push(item);
            });
            
            const container = document.getElementById('momentumHeatmap');
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-green-900/20 border-2 border-green-500/50 rounded-lg p-4">
                        <h3 class="text-lg font-bold text-green-400 mb-3">Strong & Accelerating</h3>
                        <p class="text-xs text-gray-400 mb-3">Positive momentum, gaining speed</p>
                        <div class="flex flex-wrap gap-2">
                            ${quadrants.strong_accel.map(s => 
                                `<span class="px-3 py-1 bg-green-500/20 border border-green-500/30 rounded text-sm font-mono">
                                    ${s.ticker} <span class="text-green-400">+${s.momentum[0].toFixed(1)}%</span>
                                </span>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <div class="bg-yellow-900/20 border-2 border-yellow-500/50 rounded-lg p-4">
                        <h3 class="text-lg font-bold text-yellow-400 mb-3">Strong & Decelerating</h3>
                        <p class="text-xs text-gray-400 mb-3">Positive but losing momentum</p>
                        <div class="flex flex-wrap gap-2">
                            ${quadrants.strong_decel.map(s => 
                                `<span class="px-3 py-1 bg-yellow-500/20 border border-yellow-500/30 rounded text-sm font-mono">
                                    ${s.ticker} <span class="text-yellow-400">+${s.momentum[0].toFixed(1)}%</span>
                                </span>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <div class="bg-blue-900/20 border-2 border-blue-500/50 rounded-lg p-4">
                        <h3 class="text-lg font-bold text-blue-400 mb-3">Weak & Recovering</h3>
                        <p class="text-xs text-gray-400 mb-3">Negative but gaining momentum</p>
                        <div class="flex flex-wrap gap-2">
                            ${quadrants.weak_recover.map(s => 
                                `<span class="px-3 py-1 bg-blue-500/20 border border-blue-500/30 rounded text-sm font-mono">
                                    ${s.ticker} <span class="text-blue-400">${s.momentum[0].toFixed(1)}%</span>
                                </span>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <div class="bg-red-900/20 border-2 border-red-500/50 rounded-lg p-4">
                        <h3 class="text-lg font-bold text-red-400 mb-3">Weak & Falling</h3>
                        <p class="text-xs text-gray-400 mb-3">Negative momentum, losing speed</p>
                        <div class="flex flex-wrap gap-2">
                            ${quadrants.weak_falling.map(s => 
                                `<span class="px-3 py-1 bg-red-500/20 border border-red-500/30 rounded text-sm font-mono">
                                    ${s.ticker} <span class="text-red-400">${s.momentum[0].toFixed(1)}%</span>
                                </span>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        async function init() {
            try {
                // Try to load cached stats immediately
                const cached = localStorage.getItem('marketInsights');
                if (cached) {
                    try {
                        const cachedData = JSON.parse(cached);
                        const cacheAge = Date.now() - (cachedData.timestamp || 0);
                        
                        // Show cached stats if less than 10 minutes old
                        if (cacheAge < 600000) {
                            document.getElementById('loading').classList.add('hidden');
                            document.getElementById('stats').classList.remove('hidden');
                            document.getElementById('pctAboveMA200').textContent = `${cachedData.stats.pctAboveMA200.toFixed(0)}%`;
                            document.getElementById('bullishCount').textContent = cachedData.stats.bullishCount;
                            document.getElementById('bearishCount').textContent = cachedData.stats.bearishCount;
                            document.getElementById('avgVolatility').textContent = `${cachedData.stats.avgVolatility.toFixed(1)}%`;
                        }
                    } catch (e) {
                        console.log('Cache parse error:', e);
                    }
                }

                const data = await fetchMarketData();
                
                // Cache the data
                localStorage.setItem('marketInsights', JSON.stringify({
                    ...data,
                    timestamp: Date.now()
                }));
                
                // Hide loading, show stats
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('stats').classList.remove('hidden');

                // Update stats with fresh data
                document.getElementById('pctAboveMA200').textContent = `${data.stats.pctAboveMA200.toFixed(0)}%`;
                document.getElementById('bullishCount').textContent = data.stats.bullishCount;
                document.getElementById('bearishCount').textContent = data.stats.bearishCount;
                document.getElementById('avgVolatility').textContent = `${data.stats.avgVolatility.toFixed(1)}%`;

                // Show last updated time
                const now = new Date();
                document.getElementById('updateTime').textContent = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                document.getElementById('lastUpdated').classList.remove('hidden');

                // Show charts container
                document.getElementById('charts').classList.remove('hidden');

                // Load first 3 charts immediately
                if (data.todayMovers) {
                    createTodayMoversChart(data.todayMovers);
                    document.getElementById('todayMovers').dataset.loaded = 'true';
                }
                createTenDayMoversChart(data.tenDayMovers);
                createOneMonthMoversChart(data.oneMonthMovers);
                document.getElementById('tenDayMovers').dataset.loaded = 'true';
                document.getElementById('oneMonthMovers').dataset.loaded = 'true';

                // Lazy load remaining charts on scroll
                const chartLoaders = {
                    'volatilityTrend': () => createVolatilityTrendChart(data.volatilityTrend),
                    'sectorHeatmap': () => createSectorHeatmap(data.sectorPerformance),
                    'volumePatterns': () => createVolumeChart(data.volumePatterns),
                    'momentumHeatmap': () => createMomentumHeatmap(data.momentum),
                    'rsiDistribution': () => createRSIChart(data.rsiDistribution),
                    'topPerformers': () => createTopPerformersChart(data.topPerformers)
                };

                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting && !entry.target.dataset.loaded) {
                            const loader = chartLoaders[entry.target.id];
                            if (loader) {
                                loader();
                                entry.target.dataset.loaded = 'true';
                            }
                        }
                    });
                }, { rootMargin: '200px' });

                Object.keys(chartLoaders).forEach(id => {
                    const element = document.getElementById(id);
                    if (element) observer.observe(element);
                });

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = `Failed to load market insights: ${error.message}`;
            }
        }

        // Check auth and init after DOM loads
        document.addEventListener('DOMContentLoaded', () => {
            if (checkAuth()) {
                init();
            }
        });
    </script>
</body>
</html>
