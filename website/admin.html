<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Daily Market Summary</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
        .metric-card { @apply bg-slate-800/50 border border-slate-700/50 rounded-xl p-6 hover:border-slate-600/50 transition; }
        .stat-value { @apply text-3xl font-bold text-white; }
        .stat-label { @apply text-sm text-gray-400 mt-1; }
    </style>
</head>
<body class="bg-slate-900 text-white antialiased">
    <!-- Auth Check -->
    <div id="authCheck" class="min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p class="text-gray-400">Verifying admin access...</p>
        </div>
    </div>

    <!-- Access Denied -->
    <div id="accessDenied" class="hidden min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="text-6xl mb-4">ğŸ”’</div>
            <h1 class="text-2xl font-bold mb-2">Access Denied</h1>
            <p class="text-gray-400 mb-6">Admin access is restricted</p>
            <a href="/" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg transition">Go Home</a>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
        <!-- Header -->
        <nav class="bg-slate-800/50 border-b border-slate-700">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-xl font-bold">ğŸ” Admin Dashboard</h1>
                        <p class="text-sm text-gray-400" id="adminEmail"></p>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-sm text-gray-400">Last updated: <span id="lastUpdate">-</span></span>
                        <a href="/" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition">â† Back to Site</a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-6 py-8 max-w-7xl">
            <!-- Business Overview -->
            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-6">ğŸ“Š Business Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="metric-card">
                        <div class="stat-value" id="totalUsers">-</div>
                        <div class="stat-label">ğŸ‘¥ Total Users</div>
                    </div>
                    <div class="metric-card">
                        <div class="stat-value" id="newToday">-</div>
                        <div class="stat-label">ğŸ†• New Today</div>
                    </div>
                    <div class="metric-card">
                        <div class="stat-value" id="activeUsers">-</div>
                        <div class="stat-label">ğŸ”¥ Active (24h)</div>
                    </div>
                    <div class="metric-card">
                        <div class="stat-value" id="totalAnalyses">-</div>
                        <div class="stat-label">ğŸ” Total Analyses</div>
                    </div>
                </div>
            </section>

            <!-- Usage Metrics -->
            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-6">ğŸ“ˆ Usage Metrics</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-4">ğŸ” Top Analyzed Tickers</h3>
                        <div id="topTickers" class="space-y-2 text-sm">
                            <div class="text-gray-400">Loading...</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-4">ğŸ“Š Cache Statistics</h3>
                        <div class="space-y-3">
                            <div>
                                <div class="text-2xl font-bold" id="cacheCount">-</div>
                                <div class="text-sm text-gray-400">Cached Analyses</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold" id="cacheHitRate">-</div>
                                <div class="text-sm text-gray-400">Estimated Hit Rate</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- AWS Metrics -->
            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-6">â˜ï¸ AWS Infrastructure</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-4">âš¡ Lambda Functions</h3>
                        <div id="lambdaStatus" class="space-y-2 text-sm">
                            <div class="text-gray-400">Loading...</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-4">ğŸ’¾ DynamoDB Tables</h3>
                        <div id="dynamoStatus" class="space-y-2 text-sm">
                            <div class="text-gray-400">Loading...</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-4">ğŸŒ CloudFront</h3>
                        <div id="cloudfrontStatus" class="space-y-2 text-sm">
                            <div class="text-gray-400">Loading...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Recent Users -->
            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-6">ğŸ‘¥ Recent Users</h2>
                <div class="metric-card">
                    <div id="recentUsers" class="space-y-3">
                        <div class="text-gray-400">Loading...</div>
                    </div>
                </div>
            </section>

            <!-- System Status -->
            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-6">ğŸ”„ System Status</h2>
                <div class="metric-card">
                    <div id="systemStatus" class="space-y-2">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                            <span>All systems operational</span>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        const ADMIN_EMAIL = 'prakash@dalalbytes.com';

        // Check admin access
        function checkAdminAccess() {
            // Check localStorage for user email (set during login)
            const userEmail = localStorage.getItem('userEmail');
            
            if (!userEmail) {
                console.log('No user email in localStorage');
                showAccessDenied();
                return;
            }

            console.log('User email from localStorage:', userEmail);
            
            if (userEmail === ADMIN_EMAIL) {
                showAdminDashboard(userEmail);
                loadMetrics();
            } else {
                console.log('Email does not match admin email');
                showAccessDenied();
            }
        }

        function showAccessDenied() {
            document.getElementById('authCheck').classList.add('hidden');
            document.getElementById('accessDenied').classList.remove('hidden');
        }

        function showAdminDashboard(email) {
            document.getElementById('authCheck').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            document.getElementById('adminEmail').textContent = email;
        }

        async function loadMetrics() {
            updateTimestamp();
            
            // Load all metrics
            await Promise.all([
                loadUserMetrics(),
                loadCacheMetrics(),
                loadRecentUsers()
            ]);

            // Refresh every 30 seconds
            setInterval(() => {
                loadMetrics();
            }, 30000);
        }

        async function loadUserMetrics() {
            try {
                const response = await fetch('https://xfi2u4ajm9.execute-api.us-east-1.amazonaws.com/prod/admin');
                const data = await response.json();
                
                // User metrics
                document.getElementById('totalUsers').textContent = data.users.total;
                document.getElementById('newToday').textContent = data.users.new_today;
                document.getElementById('activeUsers').textContent = data.users.active_24h;
                document.getElementById('totalAnalyses').textContent = data.usage.total_analyses;
                
                // Recent users
                const recentUsers = document.getElementById('recentUsers');
                recentUsers.innerHTML = data.users.recent.map(user => `
                    <div class="flex items-center justify-between p-3 bg-slate-700/30 rounded-lg">
                        <div>
                            <div class="font-medium">${user.email}</div>
                            <div class="text-sm text-gray-400">Joined: ${new Date(user.created).toLocaleDateString()}</div>
                        </div>
                        <div class="text-sm">
                            <span class="px-2 py-1 ${user.status === 'CONFIRMED' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'} rounded">${user.status}</span>
                        </div>
                    </div>
                `).join('');
                
                // Cache metrics
                document.getElementById('cacheCount').textContent = data.cache.count;
                document.getElementById('cacheHitRate').textContent = data.cache.hit_rate;
                
                const topTickers = document.getElementById('topTickers');
                topTickers.innerHTML = data.cache.top_tickers.map(t => `
                    <div class="flex justify-between"><span>${t.ticker}</span><span class="text-gray-400">${t.count} analyses</span></div>
                `).join('');
                
                // Lambda status
                const lambdaStatus = document.getElementById('lambdaStatus');
                lambdaStatus.innerHTML = data.aws.lambda.map(l => `
                    <div class="flex justify-between"><span>âœ… ${l.function.replace('mrktdly-', '')}</span><span class="text-gray-400">${l.invocations} calls/24h</span></div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        async function loadCacheMetrics() {
            // Loaded in loadUserMetrics
        }

        async function loadRecentUsers() {
            // Loaded in loadUserMetrics
            
            // DynamoDB status
            document.getElementById('dynamoStatus').innerHTML = `
                <div class="flex justify-between"><span>âœ… mrktdly-data</span><span class="text-gray-400">Active</span></div>
                <div class="flex justify-between"><span>âœ… mrktdly-ticker-cache</span><span class="text-gray-400">Active</span></div>
            `;

            // CloudFront status
            document.getElementById('cloudfrontStatus').innerHTML = `
                <div class="flex justify-between"><span>âœ… Distribution</span><span class="text-gray-400">Deployed</span></div>
                <div class="flex justify-between"><span>ğŸ“Š Domain</span><span class="text-gray-400">marketdly.com</span></div>
            `;
        }

        function updateTimestamp() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
        }

        // Initialize
        checkAdminAccess();
    </script>
</body>
</html>
