<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Details - MarketDly</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
    </style>
</head>
<body class="bg-slate-900 text-white antialiased">
    <!-- Navigation -->
    <nav class="bg-slate-800/50 border-b border-slate-700 sticky top-0 z-50 backdrop-blur-sm">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <a href="/" class="text-xl font-bold">üìä MarketDly</a>
                <div class="flex items-center gap-4">
                    <a href="/portfolio.html" class="text-gray-400 hover:text-white transition">‚Üê Back to Portfolios</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-8 max-w-6xl">
        <div id="loading" class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p class="text-gray-400">Loading portfolio...</p>
        </div>

        <div id="portfolioContent" class="hidden">
            <!-- Header -->
            <div class="mb-8">
                <h1 id="portfolioName" class="text-4xl font-bold mb-2"></h1>
                <p id="portfolioMeta" class="text-gray-400"></p>
            </div>

            <!-- Performance Summary -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-slate-800/50 border border-slate-700/50 rounded-xl p-6">
                    <div class="text-sm text-gray-400 mb-1">Total Return</div>
                    <div id="totalReturn" class="text-3xl font-bold"></div>
                </div>
                <div class="bg-slate-800/50 border border-slate-700/50 rounded-xl p-6">
                    <div class="text-sm text-gray-400 mb-1">Current Value</div>
                    <div id="currentValue" class="text-3xl font-bold"></div>
                </div>
                <div class="bg-slate-800/50 border border-slate-700/50 rounded-xl p-6">
                    <div class="text-sm text-gray-400 mb-1">Starting Value</div>
                    <div id="startingValue" class="text-3xl font-bold">$10,000</div>
                </div>
            </div>

            <!-- Holdings -->
            <div class="bg-slate-800/50 border border-slate-700/50 rounded-xl p-6 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold">Holdings</h2>
                    <button onclick="runBacktest()" id="backtestBtn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-medium transition">
                        üîÆ Backtest (1, 3, 5 years)
                    </button>
                </div>
                <div id="holdingsTable" class="overflow-x-auto"></div>
            </div>

            <!-- Backtest Results -->
            <div id="backtestResults" class="hidden bg-gradient-to-br from-purple-900/20 to-blue-900/20 border border-purple-500/50 rounded-xl p-6">
                <h2 class="text-2xl font-bold mb-4">üîÆ Backtest Results</h2>
                <p class="text-gray-400 mb-6">How would this portfolio have performed if started earlier?</p>
                
                <div id="backtestContent" class="space-y-6"></div>
            </div>
        </div>

        <div id="error" class="hidden text-center py-12">
            <div class="text-6xl mb-4">‚ùå</div>
            <h2 class="text-2xl font-bold mb-2">Portfolio Not Found</h2>
            <p class="text-gray-400 mb-6">This portfolio may have been deleted or doesn't exist.</p>
            <a href="/portfolio.html" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition inline-block">
                Back to Portfolios
            </a>
        </div>
    </div>

    <script>
        const API_URL = 'https://xfi2u4ajm9.execute-api.us-east-1.amazonaws.com/prod';
        const urlParams = new URLSearchParams(window.location.search);
        const portfolioId = urlParams.get('id');
        const autoBacktest = urlParams.get('backtest') === 'true';

        if (!portfolioId) {
            showError();
        } else {
            loadPortfolio();
        }

        async function loadPortfolio() {
            try {
                const response = await fetch(`${API_URL}/portfolio?portfolio_id=${portfolioId}`);
                
                if (!response.ok) {
                    showError();
                    return;
                }

                const portfolio = await response.json();

                document.getElementById('portfolioName').textContent = portfolio.portfolio_name;
                document.getElementById('portfolioMeta').textContent = `Created ${new Date(portfolio.created_at).toLocaleDateString()} ‚Ä¢ ${portfolio.is_public ? 'Public' : 'Private'}`;

                const returnPct = portfolio.total_return_pct;
                document.getElementById('totalReturn').textContent = `${returnPct >= 0 ? '+' : ''}${returnPct.toFixed(2)}%`;
                document.getElementById('totalReturn').className = `text-3xl font-bold ${returnPct >= 0 ? 'text-green-400' : 'text-red-400'}`;

                document.getElementById('currentValue').textContent = `$${portfolio.current_value.toLocaleString()}`;

                const table = `
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-slate-700">
                                <th class="text-left py-3 px-4">Ticker</th>
                                <th class="text-right py-3 px-4">Allocation</th>
                                <th class="text-right py-3 px-4">Entry Price</th>
                                <th class="text-right py-3 px-4">Current Price</th>
                                <th class="text-right py-3 px-4">Entry Value</th>
                                <th class="text-right py-3 px-4">Current Value</th>
                                <th class="text-right py-3 px-4">Return</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${portfolio.holdings.map(h => `
                                <tr class="border-b border-slate-700/50 hover:bg-slate-700/30">
                                    <td class="py-3 px-4 font-bold">${h.ticker}</td>
                                    <td class="text-right py-3 px-4">${h.allocation_pct.toFixed(1)}%</td>
                                    <td class="text-right py-3 px-4">$${h.entry_price.toFixed(2)}</td>
                                    <td class="text-right py-3 px-4">$${h.current_price.toFixed(2)}</td>
                                    <td class="text-right py-3 px-4">$${h.entry_value.toLocaleString()}</td>
                                    <td class="text-right py-3 px-4">$${h.current_value.toLocaleString()}</td>
                                    <td class="text-right py-3 px-4 font-bold ${h.return_pct >= 0 ? 'text-green-400' : 'text-red-400'}">
                                        ${h.return_pct >= 0 ? '+' : ''}${h.return_pct.toFixed(2)}%
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('holdingsTable').innerHTML = table;

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('portfolioContent').classList.remove('hidden');
                
                // Auto-run backtest if requested
                if (autoBacktest) {
                    setTimeout(() => runBacktest(), 500);
                }
            } catch (error) {
                showError();
            }
        }

        function showError() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
        }

        async function runBacktest() {
            const btn = document.getElementById('backtestBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Running backtest...';

            try {
                const response = await fetch(`${API_URL}/backtest?portfolio_id=${portfolioId}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error);
                }

                displayBacktestResults(data);
                document.getElementById('backtestResults').classList.remove('hidden');
                btn.textContent = '‚úì Backtest Complete';
            } catch (error) {
                alert('Error running backtest: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'üîÆ Backtest (1, 3, 5 years)';
            }
        }

        function displayBacktestResults(data) {
            const content = document.getElementById('backtestContent');
            
            const actualReturn = data.actual_return_pct;
            const actualDate = new Date(data.actual_created).toLocaleDateString();

            let html = `
                <div class="bg-slate-800/50 border border-slate-700/50 rounded-xl p-4 mb-4">
                    <div class="text-sm text-gray-400 mb-1">Your Actual Performance</div>
                    <div class="text-2xl font-bold ${actualReturn >= 0 ? 'text-green-400' : 'text-red-400'}">
                        ${actualReturn >= 0 ? '+' : ''}${actualReturn.toFixed(2)}%
                    </div>
                    <div class="text-sm text-gray-400">Started: ${actualDate}</div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            `;

            data.backtests.forEach(bt => {
                const diff = bt.total_return_pct - actualReturn;
                const diffColor = diff >= 0 ? 'text-green-400' : 'text-red-400';
                
                html += `
                    <div class="bg-slate-800/50 border border-slate-700/50 rounded-xl p-4">
                        <div class="text-sm text-gray-400 mb-2">${bt.years} Year${bt.years > 1 ? 's' : ''} Ago</div>
                        <div class="text-2xl font-bold ${bt.total_return_pct >= 0 ? 'text-green-400' : 'text-red-400'} mb-2">
                            ${bt.total_return_pct >= 0 ? '+' : ''}${bt.total_return_pct.toFixed(2)}%
                        </div>
                        <div class="text-xs text-gray-500 mb-3">${bt.backtest_date}</div>
                        <div class="text-sm ${diffColor}">
                            ${diff >= 0 ? 'üìà' : 'üìâ'} ${diff >= 0 ? '+' : ''}${diff.toFixed(2)}% vs actual
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-700">
                            <details class="text-sm">
                                <summary class="cursor-pointer text-gray-400 hover:text-white">Holdings breakdown</summary>
                                <div class="mt-2 space-y-1">
                                    ${bt.holdings.map(h => `
                                        <div class="flex justify-between text-xs">
                                            <span>${h.ticker}</span>
                                            <span class="${h.return_pct >= 0 ? 'text-green-400' : 'text-red-400'}">
                                                ${h.return_pct >= 0 ? '+' : ''}${h.return_pct.toFixed(1)}%
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            // Find best backtest
            const best = data.backtests.reduce((max, bt) => bt.total_return_pct > max.total_return_pct ? bt : max);
            
            html += `
                <div class="mt-6 p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                    <div class="text-sm font-medium text-blue-400 mb-1">üí° Insight</div>
                    <div class="text-sm text-gray-300">
                        Best entry would have been <strong>${best.years} year${best.years > 1 ? 's' : ''} ago</strong> 
                        (${best.backtest_date}) with a return of <strong class="text-green-400">+${best.total_return_pct.toFixed(2)}%</strong>
                    </div>
                </div>
            `;

            content.innerHTML = html;
        }
    </script>
</body>
</html>
